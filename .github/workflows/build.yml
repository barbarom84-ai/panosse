name: Build and Release

on:
  push:
    tags:
      - 'v*'  # DÃ©clenche sur tous les tags commenÃ§ant par 'v' (ex: v1.0.0, v1.1.0, etc.)

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    # 1. RÃ©cupÃ©rer le code source
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 2. Installer .NET 8.0
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    # 3. Restaurer les dÃ©pendances
    - name: Restore dependencies
      run: dotnet restore Panosse.csproj
      
    # 4. Compiler en mode Release (Single File)
    - name: Build Release
      run: |
        dotnet publish Panosse.csproj `
          -c Release `
          -r win-x64 `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:EnableCompressionInSingleFile=true `
          -p:PublishReadyToRun=true `
          -o publish
          
    # 5. Renommer l'exÃ©cutable avec la version
    - name: Rename executable
      run: |
        $version = "${{ github.ref_name }}"
        Move-Item -Path "publish\Panosse.exe" -Destination "publish\Panosse-$version.exe"
        Write-Host "Fichier renomme en Panosse-$version.exe"
        
    # 6. Calculer le checksum SHA256
    - name: Calculate SHA256
      id: checksum
      run: |
        $version = "${{ github.ref_name }}"
        $hash = (Get-FileHash -Path "publish\Panosse-$version.exe" -Algorithm SHA256).Hash
        echo "sha256=$hash" >> $env:GITHUB_OUTPUT
        Write-Host "SHA256: $hash"
        
    # 7. CrÃ©er la GitHub Release
    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Panosse ${{ github.ref_name }}
        body: |
          ## ğŸ§¹ Panosse ${{ github.ref_name }}
          
          **La serpillÃ¨re numÃ©rique pour un PC tout propre !**
          
          ### ğŸ“¦ Installation
          
          TÃ©lÃ©chargez `Panosse-${{ github.ref_name }}.exe` ci-dessous et lancez-le.
          
          **Aucune installation requise** - Version portable complÃ¨te.
          
          ### âœ¨ FonctionnalitÃ©s
          
          - ğŸ—‘ï¸ Vidage de la corbeille
          - ğŸ§¹ Nettoyage fichiers temporaires
          - ğŸŒ Cache navigateurs (Chrome, Firefox, Edge)
          - ğŸ“‹ Nettoyage registre (RunMRU, RecentDocs)
          - ğŸ“¥ Suppression .exe/.msi anciens (TÃ©lÃ©chargements)
          - ğŸ“„ Nettoyage logs Windows
          - ğŸ–¼ï¸ Cache miniatures
          - ğŸ“Š Progression dÃ©taillÃ©e avec animations
          
          ### âš ï¸ PrÃ©requis
          
          - **Windows 10/11** (64-bit)
          - **Droits administrateur** (certaines fonctions)
          - **.NET 8.0** inclus (self-contained)
          
          ### ğŸ” Checksum SHA256
          
          ```
          ${{ steps.checksum.outputs.sha256 }}
          ```
          
          ### ğŸ› Signaler un bug
          
          Ouvrez une issue : https://github.com/${{ github.repository }}/issues
          
          ---
          
          **CompilÃ© automatiquement par GitHub Actions** ğŸ¤–
        draft: false
        prerelease: false
        
    # 8. Uploader l'exÃ©cutable en tant qu'asset
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: publish/Panosse-${{ github.ref_name }}.exe
        asset_name: Panosse-${{ github.ref_name }}.exe
        asset_content_type: application/vnd.microsoft.portable-executable
        
    # 9. Afficher un rÃ©sumÃ©
    - name: Build Summary
      run: |
        Write-Host "================================" -ForegroundColor Green
        Write-Host "BUILD REUSSI !" -ForegroundColor Green
        Write-Host "================================" -ForegroundColor Green
        Write-Host ""
        Write-Host "Version: ${{ github.ref_name }}" -ForegroundColor Cyan
        Write-Host "Fichier: Panosse-${{ github.ref_name }}.exe" -ForegroundColor Cyan
        Write-Host "SHA256: ${{ steps.checksum.outputs.sha256 }}" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "Release disponible sur:" -ForegroundColor Yellow
        Write-Host "https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}" -ForegroundColor Blue

